# Cursor Rules for Vector Project

## Build Failure Auto-Fix

When a CI/CD build fails, the `.github/workflows/auto-fix-issues.yml` workflow will:
1. Create a GitHub issue with error details
2. Create a `.cursor-fix-tasks.md` file in the repository root

**If you see `.cursor-fix-tasks.md` in the repository:**
- Review the file for build failure details
- Fix the issues mentioned
- Delete the file after fixing
- Push changes to trigger a new build

## React Best Practices

### useEffect Rules
- **DO NOT** call setState synchronously in useEffect body
- **DO** use useState initializer function for initial state based on props/params
- **DO** use setTimeout/requestAnimationFrame if state update is needed in effect
- **DO** use cleanup functions for timers/subscriptions

### Example - Correct Pattern:
```typescript
// ✅ Good: Initialize state based on prop/param
const [error, setError] = useState(() => 
  !token ? 'Error message' : ''
);

// ✅ Good: Use existing hook state
const { isLoading } = useAuth();
if (isLoading) return <Loading />;

// ✅ Good: Async state update in effect
useEffect(() => {
  const timer = setTimeout(() => {
    setState(value);
  }, 0);
  return () => clearTimeout(timer);
}, [dependency]);
```

### Example - Incorrect Pattern:
```typescript
// ❌ Bad: Synchronous setState in effect
useEffect(() => {
  setError('Error message'); // Triggers cascading renders
}, [token]);
```

## Deployment Rules

### AWS Deployment Requirements

When deploying to AWS (dev, staging, or production), ensure ALL of the following are deployed:

1. **Database Changes:**
   - Create EF Core migrations for any model changes
   - Migrations run automatically on container startup
   - Verify migration files are committed to git

2. **Backend Changes:**
   - All controller, service, and model changes
   - Configuration updates (appsettings, environment variables)
   - New dependencies in `.csproj` file

3. **Frontend Changes:**
   - UI/UX changes
   - API integration changes
   - New npm dependencies in `package.json`

### Deployment Checklist

Before pushing to `develop`, `staging`, or `main`:

- [ ] Database migrations created (if DB schema changed)
- [ ] All migration files committed
- [ ] Backend code committed
- [ ] Frontend code committed
- [ ] Unit tests pass: `dotnet test`
- [ ] Linting passes: `npm run lint`
- [ ] Local Docker build succeeds
- [ ] No secrets in code or documentation
- [ ] Environment variables configured in GitHub Secrets

### Verification After Deployment

After CI/CD completes:
1. Check that backend deployed: `curl https://dev-api-url/health`
2. Check that frontend deployed: Visit frontend URL
3. Verify database migration ran: Check ECS logs
4. Test all changed functionality end-to-end

## Code Quality

- All ESLint errors must be fixed before committing
- Run `npm run lint` locally before pushing
- Unit tests must pass before deployment
- No secrets in code or documentation

## Database Migrations

### Creating Migrations
```powershell
cd backend/Vector.Api
dotnet ef migrations add MigrationName --output-dir Data/Migrations
```

### Verifying Migrations
```powershell
# List pending migrations
dotnet ef migrations list

# Check migration SQL
dotnet ef migrations script
```

### Important Notes
- Migrations run automatically on container startup (`Program.cs`)
- Always test migrations locally first
- Never modify existing migration files
- Use descriptive migration names
